// Preloaded data for dropdown menus (inserted at top of file)

export const INITIAL_DRIVERS = [
  { id: 'd1', name: 'Delgadillo', license: 'CDL-A', status: 'available', avatar: 'DE' },
  { id: 'd2', name: 'Ochoa', license: 'CDL-A', status: 'available', avatar: 'OC' },
  { id: 'd3', name: 'R.D. Garcia', license: 'CDL-A', status: 'available', avatar: 'RG' },
  { id: 'd4', name: 'Vazquez', license: 'CDL-A', status: 'available', avatar: 'VA' },
  { id: 'd5', name: 'Figueroa', license: 'CDL-A', status: 'available', avatar: 'FI' },
  { id: 'd6', name: 'Varela', license: 'CDL-A', status: 'available', avatar: 'VR' },
  { id: 'd7', name: 'Carrillo', license: 'CDL-A', status: 'available', avatar: 'CA' },
  { id: 'd8', name: 'Dominguez', license: 'CDL-A', status: 'available', avatar: 'DO' },
  { id: 'd9', name: 'Ruiz', license: 'CDL-A', status: 'available', avatar: 'RU' },
  { id: 'd10', name: 'Ucclop', license: 'CDL-A', status: 'available', avatar: 'UC' },
  { id: 'd11', name: 'Sanchez', license: 'CDL-A', status: 'available', avatar: 'SA' },
  { id: 'd12', name: 'Flores', license: 'CDL-A', status: 'available', avatar: 'FL' },
  { id: 'd13', name: 'Barraza', license: 'CDL-A', status: 'available', avatar: 'BA' },
  { id: 'd14', name: 'Burgos', license: 'CDL-A', status: 'available', avatar: 'BU' },
  { id: 'd15', name: 'Ospina', license: 'CDL-A', status: 'available', avatar: 'OS' },
  { id: 'd16', name: 'Michael', license: 'CDL-A', status: 'available', avatar: 'MI' },
  { id: 'd17', name: 'Mendez', license: 'CDL-A', status: 'available', avatar: 'ME' },
  { id: 'd18', name: 'Martinez', license: 'CDL-A', status: 'available', avatar: 'MA' },
  { id: 'd19', name: 'Corey Hdz', license: 'CDL-A', status: 'available', avatar: 'CH' },
  { id: 'd20', name: 'Ebron', license: 'CDL-A', status: 'available', avatar: 'EB' },
  { id: 'd21', name: 'Diaz', license: 'CDL-A', status: 'available', avatar: 'DI' },
  { id: 'd22', name: 'Saez', license: 'CDL-A', status: 'available', avatar: 'SZ' },
  { id: 'd23', name: 'Rodriguez', license: 'CDL-A', status: 'available', avatar: 'RO' },
  { id: 'd24', name: 'Joshua H', license: 'CDL-A', status: 'available', avatar: 'JH' },
  { id: 'd25', name: 'Gutierrez', license: 'CDL-A', status: 'available', avatar: 'GU' },
  { id: 'd26', name: 'Antuna', license: 'CDL-A', status: 'available', avatar: 'AN' },
  { id: 'd27', name: 'Tarango', license: 'CDL-A', status: 'available', avatar: 'TA' },
  { id: 'd28', name: 'Sierra', license: 'CDL-A', status: 'available', avatar: 'SI' },
  { id: 'd29', name: 'Chavez', license: 'CDL-A', status: 'available', avatar: 'CZ' },
];

export const INITIAL_TRUCKS = [
  { id: 't427', plate: '427', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't1046', plate: '1046', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't1047', plate: '1047', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't1065', plate: '1065', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't1082', plate: '1082', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4037', plate: '4037', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4064', plate: '4064', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4079', plate: '4079', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4080', plate: '4080', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4082', plate: '4082', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4098', plate: '4098', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4099', plate: '4099', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4113', plate: '4113', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4115', plate: '4115', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4124', plate: '4124', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4127', plate: '4127', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4132', plate: '4132', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4134', plate: '4134', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4145', plate: '4145', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4146', plate: '4146', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4147', plate: '4147', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4153', plate: '4153', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4155', plate: '4155', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4156', plate: '4156', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4157', plate: '4157', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4161', plate: '4161', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4164', plate: '4164', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4166', plate: '4166', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4167', plate: '4167', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4168', plate: '4168', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4169', plate: '4169', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4170', plate: '4170', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4171', plate: '4171', type: 'Truck', status: 'available', capacity: 'Standard' },
  { id: 't4178', plate: '4178', type: 'Truck', status: 'available', capacity: 'Standard' },
];

export const INITIAL_ROUTES = [
  { id: 'r1', name: 'West 1', distance: 'Local', estTime: '8h' },
  { id: 'r2', name: 'West 2', distance: 'Local', estTime: '8h' },
  { id: 'r3', name: 'GY/Route', distance: 'Regional', estTime: '10h' },
  { id: 'r4', name: 'EVE/RU', distance: 'Regional', estTime: '12h' },
  { id: 'r5', name: 'AP Route', distance: 'Long Haul', estTime: '24h+' },
];

import React, { useEffect, useMemo, useState } from 'react';

// --------------------------- Preloaded data ---------------------------
const PRELOAD_DRIVERS = [
  'Carrillo','Delgadillo','Gonzalez','Hernandez','Lopez','Martinez','Mendoza','Pena','Ramirez','Rodriguez',
  'Sanchez','Torres','Vargas','Vazquez','Vega','Villanueva','Zamora','Santos','Reyes','Alvarez',
  'Castillo','Chavez','Cruz','Diaz','Flores','Garcia','Gutierrez','Jimenez','Navarro','Ortiz'
];

const PRELOAD_TRUCKS = [
  '4113','427','4301','4310','441','4522','4599','4620','4721','4800',
  '4902','5005','5010','5112','5200','5301','5403','5508','5609','5700',
  '5804','5905','6006','6107','6208','6309','6410','6511','6612','6713',
  '6814','6915','7016','7117','7218','7319'
];

const PRELOAD_ROUTES = [
  { id: 'R-1', name: 'West Loop', distance: 12, etaMin: 25 },
  { id: 'R-2', name: 'East Run', distance: 20, etaMin: 40 },
  { id: 'R-3', name: 'South Short', distance: 6, etaMin: 12 },
  { id: 'R-4', name: 'North Express', distance: 18, etaMin: 30 }
];

// --------------------------- Helpers ---------------------------
const uid = () => Math.random().toString(36).slice(2, 9);
const nowISO = () => new Date().toISOString();
const load = (k, fallback) => {
  try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
};
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

// CSV helper
function toCSV(rows) {
  const escape = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
  const headers = Object.keys(rows[0] || {});
  const lines = [headers.map(escape).join(',')];
  for (const r of rows) lines.push(headers.map(h => escape(r[h])).join(','));
  return lines.join('\n');
}

// --------------------------- Main App ---------------------------
export default function FleetPWA(){
  // Persistence keys
  const [drivers, setDrivers] = useState(() => load('fleet.drivers', PRELOAD_DRIVERS.map((n,i)=>({ id: 'D-'+i, name:n, license: 'L-' + (1000+i) }))));
  const [trucks, setTrucks] = useState(() => load('fleet.trucks', PRELOAD_TRUCKS.map((t,i)=>({ id: 'T-'+i, plate: t, model: 'Model ' + ((i%5)+1), capacity: 4000 }))));
  const [routes, setRoutes] = useState(() => load('fleet.routes', PRELOAD_ROUTES.map((r,i)=>({ id: r.id, name: r.name, distance: r.distance, etaMin: r.etaMin }))));

  const [active, setActive] = useState(() => load('fleet.active', []));
  const [records, setRecords] = useState(() => load('fleet.records', []));

  const [view, setView] = useState('dashboard'); // dashboard | records | fleet | settings
  const [dispatchOpen, setDispatchOpen] = useState(false);
  const [filterShift, setFilterShift] = useState(null);

  // Dispatch form state
  const [form, setForm] = useState({ routeId:'', driverId:'', truckId:'', shift:'Morning' });

  // Notifications permission
  useEffect(()=>{ save('fleet.drivers', drivers); }, [drivers]);
  useEffect(()=>{ save('fleet.trucks', trucks); }, [trucks]);
  useEffect(()=>{ save('fleet.routes', routes); }, [routes]);
  useEffect(()=>{ save('fleet.active', active); }, [active]);
  useEffect(()=>{ save('fleet.records', records); }, [records]);

  // Derived availability
  const busyDriverIds = useMemo(()=> new Set(active.map(a=>a.driverId)), [active]);
  const busyTruckIds = useMemo(()=> new Set(active.map(a=>a.truckId)), [active]);

  // Auto-archive: mark completed if >24 hours active
  useEffect(()=>{
    const checkArchive = ()=>{
      const cutoff = Date.now() - 24*60*60*1000;
      const stillActive = [];
      const moved = [];
      for (const s of active){
        const start = new Date(s.startedAt).getTime();
        if (isNaN(start) || start < cutoff) moved.push({...s, completedAt: nowISO(), autoArchived: true});
        else stillActive.push(s);
      }
      if (moved.length){ setActive(stillActive); setRecords(prev=>[...moved, ...prev]); }
    };
    checkArchive();
    const id = setInterval(checkArchive, 60*1000);
    return ()=>clearInterval(id);
  }, [active]);

  // Simple permission wrapper
  async function notify(title, body){
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') await Notification.requestPermission();
    if (Notification.permission === 'granted') new Notification(title, { body });
  }

  // Dispatch action
  function dispatchCreate(){
    if (!form.driverId || !form.truckId || !form.routeId) return alert('Pick route, driver, truck');
    if (busyDriverIds.has(form.driverId) || busyTruckIds.has(form.truckId)) return alert('Driver or truck busy');
    const route = routes.find(r=>r.id===form.routeId);
    const driver = drivers.find(d=>d.id===form.driverId);
    const truck = trucks.find(t=>t.id===form.truckId);
    const item = { id: uid(), routeId: route.id, routeName: route.name, driverId: driver.id, driverName: driver.name, truckId: truck.id, truckPlate: truck.plate, shift: form.shift, status: 'Dispatched', startedAt: nowISO() };
    setActive(prev=>[item, ...prev]);
    notify('Dispatched', `${driver.name} on ${route.name}`);
    setDispatchOpen(false);
    setForm({ routeId:'', driverId:'', truckId:'', shift:'Morning' });
  }

  function completeShift(id){
    const item = active.find(a=>a.id===id);
    if (!item) return;
    const done = { ...item, status: 'Completed', completedAt: nowISO(), durationMs: new Date().getTime() - new Date(item.startedAt).getTime() };
    setActive(prev=>prev.filter(a=>a.id!==id));
    setRecords(prev=>[done, ...prev]);
    notify('Shift completed', `${item.driverName} - ${item.truckPlate}`);
  }

  // CRUD helpers
  function addDriver(name, license){ setDrivers(prev=>[{ id: 'D-'+uid(), name, license }, ...prev]); }
  function editDriver(id, fields){ setDrivers(prev=>prev.map(d=>d.id===id?{...d,...fields}:d)); }
  function deleteDriver(id){ setDrivers(prev=>prev.filter(d=>d.id!==id)); }

  function addTruck(plate, model, capacity){ setTrucks(prev=>[{ id: 'T-'+uid(), plate, model, capacity }, ...prev]); }
  function editTruck(id, fields){ setTrucks(prev=>prev.map(t=>t.id===id?{...t,...fields}:t)); }
  function deleteTruck(id){ setTrucks(prev=>prev.filter(t=>t.id!==id)); }

  function addRoute(name, distance, etaMin){ setRoutes(prev=>[{ id: 'R-'+uid(), name, distance, etaMin }, ...prev]); }
  function editRoute(id, fields){ setRoutes(prev=>prev.map(r=>r.id===id?{...r,...fields}:r)); }
  function deleteRoute(id){ setRoutes(prev=>prev.filter(r=>r.id!==id)); }

  function resetAll(){ if (!confirm('Erase all saved data? This cannot be undone.')) return; localStorage.clear(); window.location.reload(); }

  // CSV export
  function exportRecordsCSV(){ if (!records.length) return alert('No records'); const csv = toCSV(records.map(r=>({ id:r.id, driver:r.driverName, truck:r.truckPlate, route:r.routeName, shift:r.shift, startedAt:r.startedAt, completedAt:r.completedAt, autoArchived:!!r.autoArchived }))); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'fleet_records.csv'; a.click(); URL.revokeObjectURL(url); }

  // Simple PWA install prompt handler (deferred prompt)
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  useEffect(()=>{
    function handler(e){ e.preventDefault(); setDeferredPrompt(e); }
    window.addEventListener('beforeinstallprompt', handler);
    return ()=> window.removeEventListener('beforeinstallprompt', handler);
  },[]);
  function promptInstall(){ if (!deferredPrompt) return alert('Install prompt not available — use browser menu'); deferredPrompt.prompt(); }

  // Service worker register (if exists)
  useEffect(()=>{ if ('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); } }, []);

  // UI pieces below
  const activeCount = active.length;
  const availableTrucks = trucks.filter(t=>!busyTruckIds.has(t.id)).length;

  // Simple card component
  const Badge = ({children, variant='gray'})=> (
    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-${variant}-100 text-${variant}-800`}>{children}</span>
  );

  // ---------- Render ----------
  return (
    <div className="min-h-screen bg-white text-slate-900 p-4 md:p-8">
      <header className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Fleet Dispatch • Dashboard</h1>
        <div className="flex items-center gap-3">
          <div className="text-sm text-slate-600">Active: <strong>{activeCount}</strong></div>
          <div className="text-sm text-slate-600">Available: <strong>{availableTrucks}</strong></div>
          <nav className="space-x-2">
            <button onClick={()=>setView('dashboard')} className={`px-3 py-1 rounded ${view==='dashboard'?'bg-slate-100':'hover:bg-slate-50'}`}>Dashboard</button>
            <button onClick={()=>setView('fleet')} className={`px-3 py-1 rounded ${view==='fleet'?'bg-slate-100':'hover:bg-slate-50'}`}>Fleet</button>
            <button onClick={()=>setView('records')} className={`px-3 py-1 rounded ${view==='records'?'bg-slate-100':'hover:bg-slate-50'}`}>Records</button>
            <button onClick={()=>setView('settings')} className={`px-3 py-1 rounded ${view==='settings'?'bg-slate-100':'hover:bg-slate-50'}`}>Settings</button>
          </nav>
        </div>
      </header>

      {view==='dashboard' && (
        <main>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <section className="col-span-2">
              <div className="mb-4 flex items-center justify-between">
                <h2 className="text-lg font-semibold">Active Fleet</h2>
                <div className="flex items-center gap-2">
                  <label className="text-sm">Shift</label>
                  <select value={filterShift||''} onChange={e=>setFilterShift(e.target.value||null)} className="px-2 py-1 border rounded">
                    <option value="">All</option>
                    <option value="Morning">Morning</option>
                    <option value="Afternoon">Afternoon</option>
                    <option value="Night">Night</option>
                  </select>
                </div>
              </div>

              <div className="space-y-3">
                {active.filter(a=>!filterShift||a.shift===filterShift).map(a=> (
                  <div key={a.id} className="border rounded p-3 flex items-center justify-between shadow-sm">
                    <div>
                      <div className="font-medium">{a.driverName} • {a.truckPlate}</div>
                      <div className="text-sm text-slate-600">{a.routeName} • {a.shift}</div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className={`px-2 py-1 rounded-full text-xs ${a.status==='Dispatched'?'bg-amber-100 text-amber-800':'bg-green-100 text-green-800'}`}>{a.status}</span>
                      <button onClick={()=>completeShift(a.id)} className="px-3 py-1 rounded bg-green-50 hover:bg-green-100 text-green-700">Complete</button>
                    </div>
                  </div>
                ))}
                {!active.length && <div className="text-slate-500">No active assignments</div>}
              </div>
            </section>

            <aside>
              <div className="mb-4 p-3 border rounded">
                <h3 className="font-semibold">Quick Stats</h3>
                <div className="mt-2 text-sm text-slate-600">Active trucks: <strong>{activeCount}</strong></div>
                <div className="text-sm text-slate-600">Available trucks: <strong>{availableTrucks}</strong></div>
                <div className="mt-3">
                  <button onClick={()=>setDispatchOpen(true)} className="w-full px-3 py-2 rounded bg-slate-800 text-white">+ Dispatch</button>
                </div>
              </div>

              <div className="p-3 border rounded">
                <h3 className="font-semibold">Legend</h3>
                <div className="mt-2 text-sm"><span className="inline-block w-3 h-3 bg-amber-300 mr-2 align-middle rounded-full"></span> Dispatched</div>
                <div className="text-sm"><span className="inline-block w-3 h-3 bg-green-300 mr-2 align-middle rounded-full"></span> Completed/Available</div>
              </div>
            </aside>
          </div>
        </main>
      )}

      {view==='fleet' && (
        <div>
          <h2 className="text-lg font-semibold mb-3">Fleet Management</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <CrudList title="Drivers" items={drivers} onAdd={(name,license)=>addDriver(name,license)} onEdit={editDriver} onDelete={deleteDriver} fields={[{k:'name',label:'Name'},{k:'license',label:'License'}]} />
            <CrudList title="Trucks" items={trucks} onAdd={(plate,model,capacity)=>addTruck(plate,model,capacity)} onEdit={editTruck} onDelete={deleteTruck} fields={[{k:'plate',label:'Plate'},{k:'model',label:'Model'},{k:'capacity',label:'Capacity'}]} />
            <CrudList title="Routes" items={routes} onAdd={(name,distance,eta)=>addRoute(name,distance,eta)} onEdit={editRoute} onDelete={deleteRoute} fields={[{k:'name',label:'Name'},{k:'distance',label:'Distance'},{k:'etaMin',label:'ETA (min)'}]} />
          </div>
        </div>
      )}

      {view==='records' && (
        <div>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold">Records</h2>
            <div className="flex items-center gap-2">
              <button onClick={exportRecordsCSV} className="px-3 py-1 rounded bg-slate-800 text-white">Download CSV</button>
              <button onClick={()=>{ if (confirm('Clear all records?')) setRecords([]); }} className="px-3 py-1 rounded border text-slate-700">Clear</button>
            </div>
          </div>
          <div className="space-y-2">
            {records.map(r=> (
              <div key={r.id} className="p-3 border rounded flex justify-between">
                <div>
                  <div className="font-medium">{r.driverName} • {r.truckPlate}</div>
                  <div className="text-sm text-slate-600">{r.routeName} • {r.shift}</div>
                </div>
                <div className="text-sm text-slate-500">{new Date(r.startedAt).toLocaleString()} → {r.completedAt?new Date(r.completedAt).toLocaleString():'—'}</div>
              </div>
            ))}
            {!records.length && <div className="text-slate-500">No records yet.</div>}
          </div>
        </div>
      )}

      {view==='settings' && (
        <div>
          <h2 className="text-lg font-semibold mb-3">Settings</h2>
          <div className="space-y-4 max-w-xl">
            <div className="p-3 border rounded">
              <h3 className="font-semibold">Notifications</h3>
              <div className="mt-2 text-sm">Allow browser notifications to receive dispatch and completion alerts.</div>
              <div className="mt-3"><button onClick={()=>Notification.requestPermission()} className="px-3 py-1 rounded bg-slate-800 text-white">Request Permission</button></div>
            </div>

            <div className="p-3 border rounded">
              <h3 className="font-semibold text-rose-600">Danger Zone</h3>
              <div className="mt-2 text-sm text-rose-600">Reset all app data (drivers, trucks, routes, active operations, and records).</div>
              <div className="mt-3"><button onClick={resetAll} className="px-3 py-1 rounded bg-rose-600 text-white">Erase Everything</button></div>
            </div>

            <div className="p-3 border rounded">
              <h3 className="font-semibold">PWA</h3>
              <div className="mt-2 text-sm">Installable: {deferredPrompt ? 'Install prompt available' : 'Use browser menu to install'}</div>
              <div className="mt-3 flex gap-2"><button onClick={promptInstall} className="px-3 py-1 rounded bg-slate-800 text-white">Install</button></div>
            </div>
          </div>
        </div>
      )}

      {/* Dispatch Modal */}
      {dispatchOpen && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
          <div className="bg-white rounded shadow max-w-xl w-full p-4">
            <h3 className="font-semibold mb-2">Quick Dispatch</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
              <select value={form.routeId} onChange={e=>setForm(f=>({...f,routeId:e.target.value}))} className="p-2 border rounded">
                <option value="">Select route</option>
                {routes.map(r=> <option key={r.id} value={r.id}>{r.name} ({r.distance}km)</option>)}
              </select>

              <select value={form.driverId} onChange={e=>setForm(f=>({...f,driverId:e.target.value}))} className="p-2 border rounded">
                <option value="">Select driver</option>
                {drivers.filter(d=>!busyDriverIds.has(d.id)).map(d=> <option key={d.id} value={d.id}>{d.name}</option>)}
              </select>

              <select value={form.truckId} onChange={e=>setForm(f=>({...f,truckId:e.target.value}))} className="p-2 border rounded">
                <option value="">Select truck</option>
                {trucks.filter(t=>!busyTruckIds.has(t.id)).map(t=> <option key={t.id} value={t.id}>{t.plate} • {t.model}</option>)}
              </select>
            </div>

            <div className="mt-3 flex items-center gap-2">
              <label className="text-sm">Shift</label>
              <div className="flex gap-2">
                {['Morning','Afternoon','Night'].map(s=> (
                  <button key={s} onClick={()=>setForm(f=>({...f,shift:s}))} className={`px-3 py-1 rounded ${form.shift===s?'bg-slate-800 text-white':'border'}`}>{s}</button>
                ))}
              </div>
            </div>

            <div className="mt-4 flex justify-end gap-2">
              <button onClick={()=>setDispatchOpen(false)} className="px-3 py-1 rounded border">Cancel</button>
              <button onClick={dispatchCreate} className="px-3 py-1 rounded bg-slate-800 text-white">Dispatch</button>
            </div>
          </div>
        </div>
      )}

      {/* Floating Action Button */}
      <button onClick={()=>setDispatchOpen(true)} title="New dispatch" className="fixed right-6 bottom-6 w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-white bg-slate-800 text-2xl">+</button>

    </div>
  );
}

// --------------------------- Small components (inside file) ---------------------------
function CrudList({ title, items, onAdd, onEdit, onDelete, fields }){
  const [openAdd, setOpenAdd] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({});

  useEffect(()=>{ if (!openAdd) setForm({}); }, [openAdd]);
  useEffect(()=>{ if (editId){ const it = items.find(x=>x.id===editId); setForm(it||{}); } }, [editId]);

  function submitAdd(){
    if (title==='Drivers') onAdd(form.name||'Unnamed', form.license||'N/A');
    if (title==='Trucks') onAdd(form.plate||'UNK', form.model||'Model', form.capacity||0);
    if (title==='Routes') onAdd(form.name||'Route', Number(form.distance)||0, Number(form.etaMin)||0);
    setOpenAdd(false);
  }
  function submitEdit(){ onEdit(editId, form); setEditId(null); }

  return (
    <div className="p-3 border rounded">
      <div className="flex items-center justify-between mb-2">
        <h4 className="font-semibold">{title}</h4>
        <div className="flex gap-2">
          <button onClick={()=>setOpenAdd(s=>!s)} className="px-2 py-1 rounded border">Add</button>
        </div>
      </div>
      {openAdd && (
        <div className="space-y-2 mb-3">
          {fields.map(f=> (
            <input key={f.k} value={form[f.k]||''} onChange={e=>setForm(prev=>({...prev,[f.k]:e.target.value}))} className="w-full p-2 border rounded" placeholder={f.label} />
          ))}
          <div className="flex gap-2"><button onClick={submitAdd} className="px-2 py-1 rounded bg-slate-800 text-white">Create</button><button onClick={()=>setOpenAdd(false)} className="px-2 py-1 rounded border">Cancel</button></div>
        </div>
      )}

      <div className="space-y-1 max-h-80 overflow-auto">
        {items.map(it=> (
          <div key={it.id} className="flex items-center justify-between p-2 border rounded">
            <div className="text-sm">
              <div className="font-medium">{it.name||it.plate}</div>
              <div className="text-xs text-slate-500">{fields.map(f=>`${f.label}: ${it[f.k]}`).join(' • ')}</div>
            </div>
            <div className="flex gap-2">
              <button onClick={()=>setEditId(it.id)} className="px-2 py-1 rounded border text-xs">Edit</button>
              <button onClick={()=>onDelete(it.id)} className="px-2 py-1 rounded border text-xs text-rose-600">Delete</button>
            </div>
          </div>
        ))}
      </div>

      {editId && (
        <div className="mt-3 p-2 border rounded">
          <div className="space-y-2">
            {fields.map(f=> (
              <input key={f.k} value={form[f.k]||''} onChange={e=>setForm(prev=>({...prev,[f.k]:e.target.value}))} className="w-full p-2 border rounded" placeholder={f.label} />
            ))}
            <div className="flex gap-2"><button onClick={submitEdit} className="px-2 py-1 rounded bg-slate-800 text-white">Save</button><button onClick={()=>setEditId(null)} className="px-2 py-1 rounded border">Cancel</button></div>
          </div>
        </div>
      )}

    </div>
  );
}

/*
SERVICE WORKER (service-worker.js) - place in public/

self.addEventListener('install', function(e){ self.skipWaiting(); });
self.addEventListener('activate', function(e){ clients.claim(); });
self.addEventListener('fetch', function(event){
  // Simple offline strategy: respond with cached index.html for navigation
});

MANIFEST (manifest.json) - place in public/
{
  "name": "Fleet Dispatch PWA",
  "short_name": "FleetPWA",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0f172a",
  "icons": [
    { "src": "/icons/192.png", "sizes":"192x192", "type":"image/png" },
    { "src": "/icons/512.png", "sizes":"512x512", "type":"image/png" }
  ]
}

Remember: add service-worker registration snippet in index.js and ensure the service worker file is served from the root (public/service-worker.js).
*/
